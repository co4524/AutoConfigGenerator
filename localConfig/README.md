# AutoConfigGenerator
Deploy a multi node Testnet (Tendermint on EVM-lite)
- [Dependency](#jump1)
- [Run single node](#jump2)
- [Single node configuration](#jump3)
- [Four node configuration](#jump)
- [Run four node(local)](#jump4)
- [Script for N nodes Configuration(local)](#jump5)
## Dependency
<span id="jump1"></span>
### [Install Go](https://github.com/golang/go.git)  

1. Install Go on Ubuntu
```
sudo apt-get update
sudo apt-get -y upgrade
wget https://dl.google.com/go/go1.12.2.linux-amd64.tar.gz
sudo tar -xvf go1.12.2.linux-amd64.tar.gz
sudo mv go /usr/local
```
2. Setup Go Env,Written in the ```.bashrc``` file

```
export GOROOT=/usr/local/go
export GOPATH=$HOME/go
export PATH=$GOPATH/bin:$GOROOT/bin:$PATH
```

3. Verify Installation

```
go version
go env

```

### [Install evm-lite](https://github.com/bear987978897/evm-lite)

1. Download source code

```
git clone https://github.com/bear987978897/evm-lite.git
```

2. Create a new folder on ```$GOPATH``` like the structure underneath

```
host:~$ tree go
go
|-- bin
`-- src
    `-- github.com
        `-- bear987978897
```
3. Download dependencies, you need to wait a few minutes for download time

```
[...]/evm-lite$ curl https://glide.sh/get | sh
[...]/evm-lite$ glide install 
```

if error like this: ```exec: "gcc": executable file not found in $PATH``` try:

```
host$ sudo apt install gcc
```

4. If the Compile build succeeds, the main file will be generated under the directory.

```
host:~/go/src/github.com/bear987978897/evm-lite/cmd/evml$ go build main.go
```

5. Verify Installation

```
host:~$ ./main
EVM-Lite node

Usage:
  evml [command]

Available Commands:
  babble      Run the evm-lite node with Babble consensus
  help        Help about any command
  raft        Run the evm-lite node with Raft consensus
  solo        Run the evm-lite node with Solo consensus (no consensus)
  tendermint  Run the evm-lite node with Tendermint consensus
  version     Show version info

```

### [Install tendermint](https://github.com/tendermint/tendermint)  
  
1. Get Source Code

```
mkdir -p $GOPATH/src/github.com/tendermint
cd $GOPATH/src/github.com/tendermint
git clone https://github.com/tendermint/tendermint.git
cd tendermint
```

2. Get Tools & Dependencies

```
sudo apt install make (If you have "make", you don't have to execute it.)
make get_tools
make get_vendor_deps
```

3. Compile

```
make install
make build
```

4. Verify Installation

```
tendermint version
```


## Tendermint on EVM (Single node)
<span id="jump2"></span>

```
host:~$ tree .evm-lite
.evm-lite
├── eth
│   ├── genesis.json
│   ├── keystore
│   │   ├── UTC--2019-04-28T11-16-23.887467267Z--d3fe6e278f533c62dc0ffe060af4bb09b79ed0df
│   │   ├── UTC--2019-04-28T11-16-34.747473280Z--b2f094f1ba8bbb363c128b37fbe83235b3bfc0a9
│   │   └── UTC--2019-04-28T22-48-52.043804496Z--d22312c75d4132959777c8d79bf402f31ab688dc
│   └── pwd.txt
└── tendermint
    ├── config
    │   ├── config.toml
    │   ├── genesis.json
    │   ├── node_key.json
    │   └── priv_validator_key.json
    └── data
        └── priv_validator_state.json
```
1. You need to create a new ```.evm-lite/``` folder yourself.
2. ```.evm-lite/keystore``` can be generated by using ```$ geth account new``` and the ```pwd.txt``` file is used to store account password
3. the ```.evm-lite/genesis.json``` is look like this:
```
host~$ cat .evm-lite/eth/genesis.json
{
	"alloc": {
		"d3fe6e278f533c62dc0ffe060af4bb09b79ed0df":{
		"balance": "100000000"
		},
		"b2f094f1ba8bbb363c128b37fbe83235b3bfc0a9":{
		"balance": "100000000"
		},
		"d22312c75d4132959777c8d79bf402f31ab688dc":{
			"balance": "100000000"
		}
	}
}
```
4. Generate a private key and a node key for each validator using ```$tendermint init``` the default dir will be placed at ```~/.tendermint``` .you need to move it to the ```~/.evm-lite/tendermint``` folder
5. using ```$./main tendermint``` to start a single node

## Tendermint Configuration(Single node)
<span id="jump3"></span>
When ```tendermint init``` is run, both a ```genesis.json``` and ```priv_validator.json``` are created in ```~/.tendermint/config```  ```The genesis.json``` might look like:
```
{
  "genesis_time": "2019-05-10T16:32:43.525118478Z",
  "chain_id": "test-chain-XdOnks",
  "consensus_params": {
    "block": {
      "max_bytes": "22020096",
      "max_gas": "-1",
      "time_iota_ms": "1000"
    },
    "evidence": {
      "max_age": "100000"
    },
    "validator": {
      "pub_key_types": [
        "ed25519"
      ]
    }
  },
  "validators": [
    {
      "address": "1AD1EB0762E304631D2DED179FA695B5CC997B44",
      "pub_key": {
        "type": "tendermint/PubKeyEd25519",
        "value": "e36eZ2SLjldgB+POXQ2MYGZknL9cooWf3aYMQchY0wU="
      },
      "power": "10",
      "name": ""
    }
  ],
  "app_hash": ""
}
```
And the priv_validator.json:
```
host:~$ cat .evm-lite/tendermint/config/priv_validator_key.json
{
  "address": "1AD1EB0762E304631D2DED179FA695B5CC997B44",
  "pub_key": {
    "type": "tendermint/PubKeyEd25519",
    "value": "e36eZ2SLjldgB+POXQ2MYGZknL9cooWf3aYMQchY0wU="
  },
  "priv_key": {
    "type": "tendermint/PrivKeyEd25519",
    "value": "W3orXGvow/7jvqtSDYFlwnMjYHCwer3y0gC4Eqzdbmt7fp5nZIuOV2AH485dDYxgZmScv1yihZ/dpgxByFjTBQ=="
  }
}
```

## Tendermint Configuration(four node)

### ARCHITECTURE of testnet

<span id="jump"></span>

```

host:~$ tree mytestnet/
mytestnet/
├── node0
│   ├── eth
│   │   ├── genesis.json
│   │   ├── keystore
│   │   │   ├── UTC--2019-04-28T11-16-23.887467267Z--d3fe6e278f533c62dc0ffe060af4bb09b79ed0df
│   │   │   ├── UTC--2019-04-28T11-16-34.747473280Z--b2f094f1ba8bbb363c128b37fbe83235b3bfc0a9
│   │   │   └── UTC--2019-04-28T22-48-52.043804496Z--d22312c75d4132959777c8d79bf402f31ab688dc
│   │   └── pwd.txt
│   └── tendermint
│       ├── config
│       │   ├── config.toml
│       │   ├── genesis.json
│       │   ├── node_key.json
│       │   └── priv_validator_key.json
│       └── data
│           └── priv_validator_state.json
├── node1
│   ├── eth
│   │   ├── genesis.json
│   │   ├── keystore
│   │   │   ├── UTC--2019-04-28T11-16-23.887467267Z--d3fe6e278f533c62dc0ffe060af4bb09b79ed0df
│   │   │   ├── UTC--2019-04-28T11-16-34.747473280Z--b2f094f1ba8bbb363c128b37fbe83235b3bfc0a9
│   │   │   └── UTC--2019-04-28T22-48-52.043804496Z--d22312c75d4132959777c8d79bf402f31ab688dc
│   │   └── pwd.txt
│   └── tendermint
│       ├── config
│       │   ├── config.toml
│       │   ├── genesis.json
│       │   ├── node_key.json
│       │   └── priv_validator_key.json
│       └── data
│           └── priv_validator_state.json
├── node2
│   ├── eth
│   │   ├── genesis.json
│   │   ├── keystore
│   │   │   ├── UTC--2019-04-28T11-16-23.887467267Z--d3fe6e278f533c62dc0ffe060af4bb09b79ed0df
│   │   │   ├── UTC--2019-04-28T11-16-34.747473280Z--b2f094f1ba8bbb363c128b37fbe83235b3bfc0a9
│   │   │   └── UTC--2019-04-28T22-48-52.043804496Z--d22312c75d4132959777c8d79bf402f31ab688dc
│   │   └── pwd.txt
│   └── tendermint
│       ├── config
│       │   ├── config.toml
│       │   ├── genesis.json
│       │   ├── node_key.json
│       │   └── priv_validator_key.json
│       └── data
│           └── priv_validator_state.json
└── node3
    ├── eth
    │   ├── genesis.json
    │   ├── keystore
    │   │   ├── UTC--2019-04-28T11-16-23.887467267Z--d3fe6e278f533c62dc0ffe060af4bb09b79ed0df
    │   │   ├── UTC--2019-04-28T11-16-34.747473280Z--b2f094f1ba8bbb363c128b37fbe83235b3bfc0a9
    │   │   └── UTC--2019-04-28T22-48-52.043804496Z--d22312c75d4132959777c8d79bf402f31ab688dc
    │   └── pwd.txt
    └── tendermint
        ├── config
        │   ├── config.toml
        │   ├── genesis.json
        │   ├── node_key.json
        │   └── priv_validator_key.json
        └── data
            └── priv_validator_state.json
```
All nodes have the same file ```~/mytestnet/node[0-3]/tendermint/config/genesis.json```

### genesis.json example(four node):
```
host~$ cat mytestnet/node0/tendermint/config/genesis.json
{
  "genesis_time": "2019-05-15T15:33:09.487863578Z",
  "chain_id": "chain-xPgk2S",
  "validators": [
    {
      "address": "D4AD15CCE963539E45BA3EABCF822CD5CCBC3590",
      "pub_key": {
        "type": "tendermint/PubKeyEd25519",
        "value": "U5Cm24Z8Hrn1Y8ZYA2M54rsanfRFwcsdlVoJgu4RW9k="
      },
      "power": "1",
      "name": "node0"
    },
    {
      "address": "5D3EDC8710B59635AAD67DCA27E67BD30116FB31",
      "pub_key": {
        "type": "tendermint/PubKeyEd25519",
        "value": "XdxMmW/aanAAR1Yv/7aOijU4mR3D0YW+ffr5APzOQsw="
      },
      "power": "1",
      "name": "node1"
    },
    {
      "address": "55A3DBC3215A0695B29CA704819BC8B52B7D6711",
      "pub_key": {
        "type": "tendermint/PubKeyEd25519",
        "value": "SEfqgX+WZPVaJRFEkDCQo6BL7etSkV8/GhoN+dRmjnU="
      },
      "power": "1",
      "name": "node2"
    },
    {
      "address": "376BCCDFAB2DA9AD2B02745C619E9C30F22FAD0C",
      "pub_key": {
        "type": "tendermint/PubKeyEd25519",
        "value": "lWecEC2YITLt4cqwpTF5zo4aIUPDsGsEt9nQppIicFU="
      },
      "power": "1",
      "name": "node3"
    }
  ],
  "app_hash": ""
}

```
You can also add a verification node using ```tendermint init``` ,then add the public key to the file. New verification pub_key information is written in ```~/.tendermint/config/priv_validator_key.json```

## Steps of building testnet(four node local)
<span id="jump4"></span>
1. using ```tendermint testnet``` to create all the required files, just like the script
2. create ```tendermint``` directory in each ```mytestnet/node[num]``` directory and move ```mytestnet/node[0-3]/config&&mytestnet/node[0-3]/data``` into it,let the architecture be the same as [above](#jump)
3. copy ```~/.evm-lite/eth``` folder to each ```~/mytestnet/node[0-3]```
4. modify the ```config.toml``` in each ```mytestnet/node[0-3]``` ,change the port parameters(Because we put the nodes on the local side)
5. Set the p2p.persistent_peers in the ```config.toml``` for all nodes to the comma separated list of ID@IP:PORT for all nodes. Default port is 26656.  

  example:change the persistent_peers parameters like this

```
persistent_peers = "729d8e41884365e88afe1ff3c8c7c762d1da0fa1@localhost:1002,b9763e16fb0538d5645f5cf9367219ee9b41af27@localhost:2002,4688ff3c94305570b02e7cab9bb25637971d3ee7@localhost:3002,d08e011e13d2143a30c03d537a21ac946d333c22@localhost:4002"
```
6. run ```$./main tendermint -d "$HOME/mytestnet/node0" --eth.listen ":8080"```
```$./main tendermint -d "$HOME/mytestnet/node1" --eth.listen ":8081"``` 
```$./main tendermint -d "$HOME/mytestnet/node2" --eth.listen ":8082"```
```$./main tendermint -d "$HOME/mytestnet/node3" --eth.listen ":8083"```

## Script for build multi nodes
<span id="jump5"></span>
I write a automatic script for building multi node configuration file
### need to creat ```~/.evm-lite/eth``` first

```
$mkdir local
$cd local
$git clone https://github.com/co4524/AutoConfigGenerator.git
$./buildLocalEnv.sh [#number_of_nodes]
```




